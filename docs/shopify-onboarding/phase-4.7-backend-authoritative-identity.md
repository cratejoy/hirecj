# Phase 4.7: Backend-Authoritative User Identity

**Status**: üü° Planning  
**Priority**: Critical  
**Principle**: Single Source of Truth - Backend is the sole authority on user identity

## Problem Statement

Currently, user identity generation is scattered across multiple services, causing:
- Frontend generates incorrect IDs: `shop_cratejoy-dev` (string concatenation)
- Backend expects proper IDs: `usr_2230c443` (SHA256-based)
- Database foreign key violations when IDs don't match
- Already-authenticated detection fails due to ID mismatches
- Confusion about where and how user IDs should be generated

## North Star Solution

**Backend-Only Identity**: The backend is the ONLY place that generates or validates user IDs.

### Core Principles
1. **Single Source of Truth**: One function, one location for ID generation
2. **Backend-Driven**: Frontend never generates IDs, only passes raw data
3. **Fail-Safe**: If user doesn't exist, create them automatically
4. **Clear Documentation**: Extensive comments to prevent future confusion

## Implementation Plan

### 1. Frontend Changes (homepage/)

#### A. Remove ALL user ID generation
```typescript
// BEFORE (WRONG):
const userId = `shop_${shopDomain.replace('.myshopify.com', '')}`;

// AFTER (CORRECT):
// Frontend ONLY sends raw data, NEVER generates IDs
const sessionUpdate = {
  type: 'session_update',
  data: {
    merchant_id: merchantId,     // From localStorage
    shop_domain: shopDomain      // From localStorage
    // NO user_id field!
  }
};
```

#### B. Update localStorage handling
- Continue storing `merchantId` and `shopDomain`
- NEVER store or generate `user_id`
- Add clear comments explaining why

### 2. Backend Changes (agents/)

#### A. WebSocket session_update handler
```python
elif message_type == "session_update":
    # Frontend sends raw merchant data, backend handles identity
    update_data = data.get("data", {})
    session = self.sessions.get(conversation_id, {})
    
    # Store raw data in WebSocket session
    session.update(update_data)
    self.sessions[conversation_id] = session
    
    # NO user_id generation here - happens in start_conversation
    logger.info(f"[SESSION_UPDATE] Stored merchant data for {conversation_id}")
```

#### B. start_conversation handler updates
```python
# When creating a new session:
ws_session = self.sessions.get(conversation_id, {})
shop_domain = ws_session.get("shop_domain")
user_id = None

# Backend is the ONLY place that generates user IDs
if shop_domain:
    try:
        from shared.user_identity import get_or_create_user
        user_id, is_new = get_or_create_user(shop_domain)
        logger.info(f"[USER_IDENTITY] Backend generated: {user_id} for {shop_domain}")
    except Exception as e:
        logger.error(f"[USER_IDENTITY] Failed to get/create user: {e}")
        # Continue without user_id rather than fail
```

#### C. OAuth completion handler
- Already works correctly (uses `generate_user_id`)
- Add comments explaining this is the authoritative path

### 3. Documentation Updates

#### A. Update README files
- agents/README.md: Add "User Identity" section
- homepage/README.md: Document that frontend never generates IDs
- shared/README.md: Document the authoritative identity functions

#### B. Code Comments
Add clear warnings in critical locations:
```python
# WARNING: User IDs are ONLY generated by backend using shared.user_identity
# Frontend should NEVER attempt to generate user IDs
# Always use get_or_create_user(shop_domain) for consistency
```

### 4. Testing & Verification

#### A. Test already-authenticated detection
1. Login via Shopify OAuth
2. Navigate to shopify_onboarding workflow
3. Verify automatic transition to ad_hoc_support
4. Check logs for correct user_id (usr_xxxxxxxx format)

#### B. Test new user creation
1. Clear browser data
2. Start shopify_onboarding without OAuth
3. Complete OAuth flow
4. Verify user created with correct ID

### 5. Migration & Cleanup

#### A. Remove invalid user records
```sql
-- Find any incorrectly formatted user IDs
SELECT * FROM users WHERE id LIKE 'shop_%';
-- These should be migrated or removed
```

#### B. Add database constraints
```sql
-- Ensure user IDs follow correct format
ALTER TABLE users ADD CONSTRAINT check_user_id_format 
CHECK (id ~ '^usr_[a-f0-9]{8}$');
```

## Success Criteria

1. ‚úÖ Frontend never generates user IDs
2. ‚úÖ Backend consistently uses `get_or_create_user()`
3. ‚úÖ Already-authenticated detection works reliably
4. ‚úÖ No more foreign key violations
5. ‚úÖ Clear documentation prevents future confusion

## Anti-Patterns to Prevent

### ‚ùå NEVER: Frontend ID Generation
```javascript
// WRONG - Frontend should NEVER do this
const userId = `shop_${shopDomain.replace('.myshopify.com', '')}`;
const userId = generateUserId(shopDomain);  // No!
```

### ‚ùå NEVER: Multiple ID Formats
```python
# WRONG - Inconsistent ID generation
user_id = f"shop_{shop_name}"  # No!
user_id = f"user_{timestamp}"  # No!
user_id = merchant_id          # No!
```

### ‚úÖ ALWAYS: Backend Authority
```python
# CORRECT - Single source of truth
from shared.user_identity import get_or_create_user
user_id, is_new = get_or_create_user(shop_domain)
```

## Long-term Benefits

1. **Simplicity**: One place to look for ID generation
2. **Reliability**: Consistent IDs across all services
3. **Maintainability**: Clear documentation prevents regression
4. **Security**: Backend validates all identity claims

## Implementation Order

1. Document the plan (this file) ‚úÖ
2. Update backend handlers with comments
3. Update frontend to remove ID generation
4. Test thoroughly
5. Update README files
6. Add database constraints
7. Clean up any bad data

This phase ensures user identity is handled correctly and consistently across the entire system, following our Backend-Driven principle.